<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Первый лис на луне</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="../lib/book/book.css">
  <script type="text/javascript" src="../lib/book/Book.js"></script>
  <link rel="stylesheet" href="control/control.css">
  <script type="text/javascript" src="control/Control.js"></script>

  <style>
    html {
      --page-aspect-ratio: calc(1504/1622);
    }
    .book {
      --page-aspect-ratio: calc(1504/1622);
      --border: 2px solid #ddd;
      --border-radius: 4%;
    }
    .book__img {
      width: 100%;
    }
    .book__page {
      background-color: #ddd;
      line-height: 0;
    }

    .content {
      position: relative;
    }
    .content__book {
      width: 100%;
    }
    .content__hint {
      position: absolute;
      top: 0;
      left: 0;
      width: 50%;
    }
    .content__hint-video {
      width: 100%;
      margin-top: 10%;
    }

    html {
      height: 100%;
      --page-aspect-ratio: calc(1504/1622);
    }

    .body {
      --links-size: 80px;
      --body-margin: 8px;
      --links-margin: 8px;
      --links-self-margin: 60px;
      overflow: hidden;
      margin: 0;
      height: 100%;
      display: flex;
    }
    .content {
      width: calc(100% - var(--body-margin) * 2);
      max-width: calc((100vh - var(--body-margin) * 2 - var(--links-size) - var(--links-margin)) * var(--page-aspect-ratio) * 2);
      margin: auto auto;
    }
    .content__links {
      margin: var(--links-margin) auto 0;
      width: 100%;
    }

    .links {
      display: flex;
      justify-content: space-around;
    }
    .links__item {
      display: inline-block;
      flex-shrink: 0;
      width: var(--links-size);
      height: var(--links-size);
      opacity: 0.66;
      transition: transform 0.25s;
      background-size: 100% 100%;
      background-position: center center;
      background-repeat: no-repeat;
    }
    .links__item:hover,
    .links__item:active,
    .links__item:focus {
      outline: none;
      opacity: 1;
      transform: translateY(-3px);
    }
    .links__item:active {
      opacity: 1;
      transform: translateY(0);
      transition: transform 0.02s;
    }
    .links__item_type_inst {
      background-image: url(../img/insta.png);
    }
    .links__item_type_fb {
      background-image: url(../img/fb.png);
    }
    .links__item_type_mail {
      background-image: url(../img/mail.png);
    }
    .links__item_type_insta-only {
      background-image: url(pages/insta.jpg);
      width: calc(var(--links-size) * 640 / 155);
    }
  </style>
  <script defer>
    let pages;
    let book;
    let control;

    const onPageVisibilityChange = ({ detail: { index, visible } }) => {
      if (!visible) {
        return;
      }

      const { onceOpened, video, image } = pages[index];

      if (onceOpened) {
        return;
      }

      pages[index].onceOpened = true;

      if (video) {
        video.removeAttribute('preload');
        video.load();
      }

      if (image) {
        image.setAttribute('src', image.dataset.src);
      }
    };

    const tryToPlay = () => {
      if (!book) {
        return;
      }

      const currentPage = book.currentPage;
      const visiblePages = book.visiblePages;

      visiblePages.forEach(pageIndex => {
        const page = pages[pageIndex];
        if (!page.video || page.isDependant || !page.video.readyState === 4 || page.played) {
          return;
        }

        const isCurrent = pageIndex === currentPage || pageIndex === (currentPage + 1);

        if (!page.dependantVideo) {
          if (isCurrent || (page.video.loop && book.isPageTurning)) {
            page.video.play();
            page.played = true;
          }

          return;
        }

        if (!page.dependantVideo.readyState === 4) {
          return;
        }

        if (isCurrent || (page.video.loop && book.isPageTurning)) {
          page.video.play();
          page.dependantVideo.play();
          page.played = true;
        }
      });
    };

    const syncDependencies = () => {
      book.visiblePages.forEach(pageIndex => {
        const page = pages[pageIndex];
        if (!page.video || !page.dependantVideo || !page.played) {
          return;
        }

        if (Math.abs(page.video.currentTime - page.dependantVideo.currentTime) < 0.05) {
          return;
        }

        page.dependantVideo.currentTime = page.video.currentTime;
        page.video.currentTime = page.dependantVideo.currentTime;
      });
    };

    const onVideoReady = event => {
      tryToPlay();
    };

    const onCurrentPageChange = ({ detail: { currentPage, previousPage } }) => {
      if (currentPage === previousPage) {
        return;
      }

      tryToPlay();
      [previousPage, previousPage + 1].forEach(pageIndex => {
        const page = pages[pageIndex];

        if (!page || !page.video || page.isDependant || !page.video.readyState === 4) {
          return;
        }

        page.video.pause();
        page.video.currentTime = 0;
        page.played = false;

        if (!page.dependantVideo || !page.dependantVideo.readyState === 4) {
          return;
        }

        page.dependantVideo.pause();
        page.dependantVideo.currentTime = 0;
      });
    };

    window.onload = () => {
      const bookDomElement = document.getElementById('book');

      pages = Array.from(bookDomElement.getElementsByClassName('book__page'))
        .map((page, pageIndex) => ({
          video: page.getElementsByTagName('video')[0],
          image: page.getElementsByTagName('img')[0],
          onceOpened: false,
          pageIndex,
          played: false,
        }))
      ;

      let controlPageIndex;
      pages.forEach(({ video, pageIndex }) => {
        if (!video) {
          return;
        }

        video.$pageIndex = pageIndex;

        if (video.dataset.dependant) {
          pages[pageIndex].isDependant = true;
        }

        if (video.dataset.leadof) {
          pages[pageIndex].dependantVideo = document.getElementById(video.dataset.leadof);
        }

        if (video.id === 'control-video') {
          controlPageIndex = pageIndex;
        }

        video.addEventListener('canplaythrough', onVideoReady);
      });

      bookDomElement.addEventListener('pageVisibilityChange', onPageVisibilityChange);
      bookDomElement.addEventListener('currentPageChange', onCurrentPageChange);
      book = new Book(bookDomElement);

      control = new Control({
        page: document.getElementById('control'),
        video: document.getElementById('control-video'),
        book,
        pageIndex: controlPageIndex,
      });

      setInterval(syncDependencies, 500);
    };
  </script>
</head>
<body class="body">
  <div class="content">
    <div class="content__hint">
      <video class="content__hint-video" autoplay="autoplay" loop="loop" muted="muted" playsinline="playsinline">
        <source src="pages/hint_640.mp4" type="video/mp4" />
      </video>
    </div>
    <div class="book content__book" id="book">
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/cover-front_640.webm" type="video/webm" />-->
          <source src="pages/cover-front_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/want-to-the-moon-l_640.webm" type="video/webm" />-->
          <source src="pages/want-to-the-moon-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/want-to-the-moon-r_640.webm" type="video/webm" />-->
          <source src="pages/want-to-the-moon-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-leadof="need-home-r">
          <!--<source src="pages/need-home-l_640.webm" type="video/webm" />-->
          <source src="pages/need-home-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-dependant="true" id="need-home-r">
          <!--<source src="pages/need-home-r_640.webm" type="video/webm" />-->
          <source src="pages/need-home-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-leadof="want-to-film-r">
          <!--<source src="pages/want-to-film-l_640.webm" type="video/webm" />-->
          <source src="pages/want-to-film-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-dependant="true" id="want-to-film-r">
          <!--<source src="pages/want-to-film-r_640.webm" type="video/webm" />-->
          <source src="pages/want-to-film-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <img class="book__img" src="" data-src="pages/everything-is-project-l.jpg" />
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/everything-is-project-r_640.webm" type="video/webm" />-->
          <source src="pages/everything-is-project-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-leadof="target-r">
          <!--<source src="pages/target-l_640.webm" type="video/webm" />-->
          <source src="pages/target-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-dependant="true" id="target-r">
          <!--<source src="pages/target-r_640.webm" type="video/webm" />-->
          <source src="pages/target-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/project-or-not-l_640.webm" type="video/webm" />-->
          <source src="pages/project-or-not-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/project-or-not-r_640.webm" type="video/webm" />-->
          <source src="pages/project-or-not-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-leadof="deadline-r">
          <!--<source src="pages/deadline-l_640.webm" type="video/webm" />-->
          <source src="pages/deadline-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-dependant="true" id="deadline-r">
          <!--<source src="pages/deadline-r_640.webm" type="video/webm" />-->
          <source src="pages/deadline-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" muted="muted" playsinline="playsinline" preload="none" data-leadof="list-r">
          <!--<source src="pages/list-l_640.webm" type="video/webm" />-->
          <source src="pages/list-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" muted="muted" playsinline="playsinline" preload="none" data-dependant="true" id="list-r">
          <!--<source src="pages/list-r_640.webm" type="video/webm" />-->
          <source src="pages/list-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-leadof="plan-r">
          <!--<source src="pages/plan-l_640.webm" type="video/webm" />-->
          <source src="pages/plan-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none" data-dependant="true" id="plan-r">
          <!--<source src="pages/plan-r_640.webm" type="video/webm" />-->
          <source src="pages/plan-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <img class="book__img" src="" data-src="pages/right-order-l.jpg" />
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/right-order-r_640.webm" type="video/webm" />-->
          <source src="pages/right-order-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <img class="book__img" src="" data-src="pages/manage-l.jpg" />
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/manage-r_640.webm" type="video/webm" />-->
          <source src="pages/manage-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" muted="muted" playsinline="playsinline" preload="none" id="control-video">
          <!--<source src="pages/control-l_640.webm" type="video/webm" />-->
          <source src="pages/control-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page control" id="control">
        <img data-src="pages/control-r.jpg" class="book__img control__back" />
        <div class="control__arrow"></div>
        <div class="control__message"></div>
        <button class="control__button"></button>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/writing-report-l_640.webm" type="video/webm" />-->
          <source src="pages/writing-report-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <img class="book__img" src="" data-src="pages/writing-report-r.jpg" />
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/report-l_640.webm" type="video/webm" />-->
          <source src="pages/report-l_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <video class="book__img" loop="loop" muted="muted" playsinline="playsinline" preload="none">
          <!--<source src="pages/report-r_640.webm" type="video/webm" />-->
          <source src="pages/report-r_640.mp4" type="video/mp4" />
        </video>
      </div>
      <div class="book__page">
        <img class="book__img" src="" data-src="pages/cover-back.jpg" />
      </div>
    </div>
    <div class="links content__links">
      <a
        href="https://www.instagram.com/maristorii/"
        target="_blank"
        class="links__item links__item_type_insta-only"
        title="Instagram: maristorii"
      ></a>
    </div>
  </div>


  <!-- Yandex.Metrika counter -->
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(55540834, "init", {
      clickmap:true,
      trackLinks:true,
      accurateTrackBounce:true
    });
  </script>
  <noscript>
    <div><img src="https://mc.yandex.ru/watch/55540834" style="position:absolute; left:-9999px;" alt="" /></div>
  </noscript>
  <!-- /Yandex.Metrika counter -->
</body>
</html>
